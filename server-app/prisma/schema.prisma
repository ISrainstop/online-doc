// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  passwordHash  String
  email         String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // å…³ç³»å­—æ®µ
  documents     Document[]             // ç”¨æˆ·åˆ›å»ºçš„æ–‡æ¡£
  collaborations DocumentCollaborator[] // ç”¨æˆ·å‚ä¸åä½œçš„æ–‡æ¡£
  
  // ğŸ”¥ æ–°å¢ï¼šç”¨æˆ·åˆ›å»ºçš„å†å²ç‰ˆæœ¬ (è§£å†³ Error: missing opposite relation field)
  createdVersions DocumentVersion[]    
}

model Document {
  id            String   @id @default(uuid())
  title         String
  content       Json?    // Tiptap JSON å†…å®¹
  contentText   String?  // çº¯æ–‡æœ¬ç”¨äºæœç´¢
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isDeleted     Boolean  @default(false)

  // å…³è”ï¼šåˆ›å»ºè€…
  createdById   String
  createdBy     User     @relation(fields: [createdById], references: [id])

  // å…³è”ï¼šåä½œè€…
  collaborators DocumentCollaborator[]

  // ğŸ”¥ æ–°å¢ï¼šç‰ˆæœ¬å†å²
  versions      DocumentVersion[]
}

model DocumentCollaborator {
  id          String   @id @default(uuid())
  documentId  String
  userId      String
  permission  String   // 'VIEW' | 'EDIT' | 'OWNER'
  createdAt   DateTime @default(now())

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
}

// ğŸ”¥ æ–°å¢ï¼šç‰ˆæœ¬å†å²è¡¨
model DocumentVersion {
  id          String   @id @default(uuid())
  content     Json     // å­˜å‚¨é‚£ä¸€åˆ»çš„å®Œæ•´æ–‡æ¡£å†…å®¹
  versionName String?  // ç‰ˆæœ¬åç§°
  createdAt   DateTime @default(now())

  // å…³è”ï¼šæ‰€å±æ–‡æ¡£
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // å…³è”ï¼šè°åˆ›å»ºçš„è¿™ä¸ªç‰ˆæœ¬
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
}